<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paparan Data dari Google Sheet dengan Penapisan</title>
    <!-- Menggunakan Tailwind CSS untuk reka bentuk yang kemas dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style untuk loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style untuk butang yang dilumpuhkan (disabled) */
        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Data dari Google Sheet</h1>
                <p class="mt-1 text-gray-600">Gunakan tapisan di bawah untuk meneroka data.</p>
            </div>

            <!-- Bahagian Score Card -->
            <div id="score-card-container" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 border-b border-gray-200">
                <!-- Card Jumlah Sekolah -->
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg shadow">
                    <h4 class="font-semibold text-blue-800">Jumlah Sekolah Unik</h4>
                    <p id="sekolah-count" class="text-3xl font-bold text-blue-900">0</p>
                </div>
                <!-- Card Jumlah Panitia -->
                <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg shadow">
                    <h4 class="font-semibold text-green-800">Jumlah Panitia Unik</h4>
                    <p id="panitia-count" class="text-3xl font-bold text-green-900">0</p>
                </div>
            </div>

            <!-- Bahagian Kawalan Penapisan -->
            <div id="filter-controls" class="p-6 bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Tapis Data</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Filter untuk PPD -->
                    <div>
                        <label for="ppd-filter" class="block text-sm font-medium text-gray-700">PPD</label>
                        <select id="ppd-filter" name="ppd-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option>Semua PPD</option>
                        </select>
                    </div>
                    <!-- Filter untuk NAMA SEKOLAH -->
                    <div>
                        <label for="sekolah-filter" class="block text-sm font-medium text-gray-700">Nama Sekolah</label>
                        <select id="sekolah-filter" name="sekolah-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option>Semua Sekolah</option>
                        </select>
                    </div>
                    <!-- Filter untuk NAMA PANITIA -->
                    <div>
                        <label for="panitia-filter" class="block text-sm font-medium text-gray-700">Nama Panitia</label>
                        <select id="panitia-filter" name="panitia-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option>Semua Panitia</option>
                        </select>
                    </div>
                    <!-- Butang Reset -->
                    <div class="self-end">
                         <button id="reset-button" class="w-full bg-red-600 text-white py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Reset Tapisan</button>
                    </div>
                </div>
            </div>

            <div id="data-container" class="p-6">
                <div id="loading" class="flex flex-col items-center justify-center text-center">
                    <div class="loader mb-4"></div>
                    <p class="text-lg font-medium">Memuatkan data, sila tunggu...</p>
                </div>

                <div class="overflow-x-auto">
                    <table id="dataTable" class="min-w-full divide-y divide-gray-200 hidden">
                        <thead class="bg-gray-50"></thead>
                        <tbody class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>

                <!-- Bahagian Kawalan Halaman (Pagination) -->
                <div id="pagination-controls" class="hidden mt-4 flex items-center justify-between">
                    <button id="back-button" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Back</button>
                    <span id="page-info" class="text-sm text-gray-700"></span>
                    <button id="next-button" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Next</button>
                </div>

                 <div id="no-results" class="hidden text-center text-gray-600 bg-yellow-100 p-4 rounded-lg">
                    <p class="font-bold">Tiada hasil padanan ditemui.</p>
                    <p>Sila ubah pilihan tapisan anda atau tekan butang Reset.</p>
                </div>
                <div id="error" class="hidden text-center text-red-600 bg-red-100 p-4 rounded-lg">
                    <p class="font-bold">Gagal memuatkan data!</p>
                    <p>Sila pastikan URL Web App adalah betul dan Google Apps Script telah dikemas kini dan di-deploy dengan betul.</p>
                </div>
            </div>
        </div>
        <footer class="text-center mt-6 text-sm text-gray-500">
            <p>Dikuasakan oleh Google Apps Script & Tailwind CSS</p>
        </footer>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwzEP2lTDgbjD-RYjk7hyLKVfWFtzoBd1MZiZuYt3ZsO8vLw2BEr6OyBEA7OBYLWviTjQ/exec';

        const dataTable = document.getElementById('dataTable');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const noResultsDiv = document.getElementById('no-results');
        const paginationControls = document.getElementById('pagination-controls');
        
        const ppdFilter = document.getElementById('ppd-filter');
        const sekolahFilter = document.getElementById('sekolah-filter');
        const panitiaFilter = document.getElementById('panitia-filter');
        const resetButton = document.getElementById('reset-button');
        const backButton = document.getElementById('back-button');
        const nextButton = document.getElementById('next-button');
        const pageInfo = document.getElementById('page-info');
        const sekolahCountEl = document.getElementById('sekolah-count');
        const panitiaCountEl = document.getElementById('panitia-count');

        let originalData = [];
        let currentFilteredRows = [];
        let ppdIndex = -1, sekolahIndex = -1, panitiaIndex = -1;
        
        let currentPage = 1;
        const rowsPerPage = 10;

        function handleData(data) {
            loadingDiv.style.display = 'none';
            if (data && data.length > 1) {
                originalData = data;
                initializeFiltersAndDisplay();
            } else {
                errorDiv.style.display = 'block';
                errorDiv.querySelector('p:last-child').textContent = 'Tiada data diterima atau data kosong.';
            }
            const scriptTag = document.getElementById('jsonp-script');
            if (scriptTag) scriptTag.remove();
        }
        
        function initializeFiltersAndDisplay() {
            const headers = originalData[0];
            ppdIndex = headers.indexOf('PPD');
            sekolahIndex = headers.indexOf('NAMA SEKOLAH');
            panitiaIndex = headers.indexOf('NAMA PANITIA');
            
            if(sekolahIndex === -1) console.warn("Lajur 'NAMA SEKOLAH' tidak ditemui.");
            if(panitiaIndex === -1) console.warn("Lajur 'NAMA PANITIA' tidak ditemui.");

            handleFilterChange();
        }

        function handleFilterChange() {
            // 1. Dapatkan nilai semasa
            const selectedPPD = ppdFilter.value;
            const selectedSekolah = sekolahFilter.value;
            const selectedPanitia = panitiaFilter.value;

            // 2. Tapis data berdasarkan setiap pilihan
            let ppdFiltered = originalData.slice(1);
            if (!selectedPPD.startsWith('Semua')) {
                ppdFiltered = ppdFiltered.filter(row => row[ppdIndex] === selectedPPD);
            }

            let sekolahFiltered = ppdFiltered;
            if (!selectedSekolah.startsWith('Semua')) {
                sekolahFiltered = sekolahFiltered.filter(row => row[sekolahIndex] === selectedSekolah);
            }
            
            let panitiaFiltered = sekolahFiltered;
            if (!selectedPanitia.startsWith('Semua')) {
                panitiaFiltered = panitiaFiltered.filter(row => row[panitiaIndex] === selectedPanitia);
            }
            
            // 3. Kemas kini pilihan dropdown berdasarkan data yang relevan
            updateDropdownOptions(ppdFiltered, sekolahFiltered, panitiaFiltered);

            // 4. Paparkan data yang ditapis sepenuhnya
            currentFilteredRows = panitiaFiltered;
            updateScoreCards(currentFilteredRows);
            currentPage = 1;
            displayCurrentPage();
        }

        function updateDropdownOptions(ppdFiltered, sekolahFiltered, panitiaFiltered) {
            const selectedPPD = ppdFilter.value;
            const selectedSekolah = sekolahFilter.value;
            const selectedPanitia = panitiaFilter.value;

            // Kemas kini PPD
            const ppdOptions = new Set(originalData.slice(1).filter(row => 
                (selectedSekolah.startsWith('Semua') || row[sekolahIndex] === selectedSekolah) &&
                (selectedPanitia.startsWith('Semua') || row[panitiaIndex] === selectedPanitia)
            ).map(row => row[ppdIndex]));
            populateSelect(ppdFilter, [...ppdOptions].sort(), selectedPPD);

            // Kemas kini Sekolah
            const sekolahOptions = new Set(ppdFiltered.filter(row => 
                (selectedPanitia.startsWith('Semua') || row[panitiaIndex] === selectedPanitia)
            ).map(row => row[sekolahIndex]));
            populateSelect(sekolahFilter, [...sekolahOptions].sort(), selectedSekolah);

            // Kemas kini Panitia
            const panitiaOptions = new Set(sekolahFiltered.map(row => row[panitiaIndex]));
            populateSelect(panitiaFilter, [...panitiaOptions].sort(), selectedPanitia);
        }
        
        function populateSelect(selectElement, options, selectedValue) {
            // Simpan pilihan pertama ("Semua...")
            const firstOption = selectElement.options[0];
            selectElement.innerHTML = '';
            selectElement.appendChild(firstOption);

            options.forEach(optionText => {
                if(optionText) { // Pastikan tiada pilihan kosong
                    const option = document.createElement('option');
                    option.value = optionText;
                    option.textContent = optionText;
                    selectElement.appendChild(option);
                }
            });
            selectElement.value = selectedValue;
        }
        
        function updateScoreCards(filteredRows) {
            const sekolahSet = new Set();
            const panitiaSet = new Set();

            filteredRows.forEach(row => {
                if (sekolahIndex !== -1 && row[sekolahIndex]) sekolahSet.add(row[sekolahIndex]);
                if (panitiaIndex !== -1 && row[panitiaIndex]) panitiaSet.add(row[panitiaIndex]);
            });
            
            sekolahCountEl.textContent = sekolahSet.size;
            panitiaCountEl.textContent = panitiaSet.size;
        }

        function resetFilters() {
            ppdFilter.selectedIndex = 0;
            sekolahFilter.selectedIndex = 0;
            panitiaFilter.selectedIndex = 0;
            handleFilterChange();
        }
        
        function displayCurrentPage() {
            const totalRows = currentFilteredRows.length;
            if (totalRows === 0) {
                dataTable.style.display = 'none';
                paginationControls.style.display = 'none';
                noResultsDiv.style.display = 'block';
                return;
            }

            dataTable.style.display = 'table';
            paginationControls.style.display = 'flex';
            noResultsDiv.style.display = 'none';

            const startIndex = (currentPage - 1) * rowsPerPage;
            const pageRows = currentFilteredRows.slice(startIndex, startIndex + rowsPerPage);
            
            const pageData = [originalData[0], ...pageRows];
            populateTable(pageData, startIndex);
            updatePaginationControls();
        }

        function updatePaginationControls() {
            const totalRows = currentFilteredRows.length;
            const totalPages = Math.ceil(totalRows / rowsPerPage);

            pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages || 1}`;
            backButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages || totalPages === 0;
        }

        function populateTable(data, startIndex) {
            const columnsToDisplay = ['PPD', 'NAMA SEKOLAH', 'NAMA PANITIA', 'NAMA KETUA PANITIA', 'NO. TELEFON KETUA PANITIA'];
            
            const thead = dataTable.querySelector('thead');
            const tbody = dataTable.querySelector('tbody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            const originalHeaders = data[0];
            const displayIndices = columnsToDisplay.map(colName => 
                originalHeaders.findIndex(header => header.trim().toUpperCase() === colName.trim().toUpperCase())
            );

            const headerRow = document.createElement('tr');
            
            const numHeader = document.createElement('th');
            numHeader.scope = 'col';
            numHeader.className = 'px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider';
            numHeader.textContent = 'Bil.';
            headerRow.appendChild(numHeader);

            displayIndices.forEach(index => {
                if (index !== -1) {
                    const th = document.createElement('th');
                    th.scope = 'col';
                    th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                    th.textContent = originalHeaders[index];
                    headerRow.appendChild(th);
                }
            });
            thead.appendChild(headerRow);

            const dataRows = data.slice(1);
            dataRows.forEach((rowData, rowIndex) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                
                const numCell = document.createElement('td');
                numCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-center';
                numCell.textContent = startIndex + rowIndex + 1;
                tr.appendChild(numCell);

                displayIndices.forEach(index => {
                    if (index !== -1) {
                        const td = document.createElement('td');
                        td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-700';
                        td.textContent = rowData[index] || '';
                        tr.appendChild(td);
                    }
                });
                tbody.appendChild(tr);
            });
        }
        
        function fetchData() {
            const script = document.createElement('script');
            script.id = 'jsonp-script';
            script.src = `${WEB_APP_URL}?callback=handleData`;
            script.onerror = function() {
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                console.error("Ralat memuatkan skrip dari Google.");
                const scriptTag = document.getElementById('jsonp-script');
                if (scriptTag) scriptTag.remove();
            };
            document.head.appendChild(script);
        }

        ppdFilter.addEventListener('change', handleFilterChange);
        sekolahFilter.addEventListener('change', handleFilterChange);
        panitiaFilter.addEventListener('change', handleFilterChange);
        resetButton.addEventListener('click', resetFilters);
        
        backButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                displayCurrentPage();
            }
        });

        nextButton.addEventListener('click', () => {
            const totalPages = Math.ceil(currentFilteredRows.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayCurrentPage();
            }
        });
        
        document.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>
</html>
